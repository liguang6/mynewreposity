<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.byd.wms.business.modules.account.dao.WmsReturnGoodsVoucherReversalDao">
	
	<resultMap type="Map" id="wmsDocMap">
		<result property="LABEL_NO"  column="LABEL_NO" jdbcType="CLOB" javaType = "java.lang.String" />
	</resultMap>
	
	<select id="getWmsDocHeadInfo" parameterType="Map" resultMap="wmsDocMap">
	SELECT I.requirement_no,I.Requirement_Item_No,(I.QTY_WMS-nvl(I.QTY_CANCEL,0)) as QTY_WMS_MAX,(I.QTY_WMS-nvl(I.QTY_CANCEL,0)) as QTY_WMS,
	 I.*,H.PZ_DATE,B.BUSINESS_CLASS,B.GM_CODE,Q.INSPECTION_ITEM_STATUS,
	 NVL(P.TEST_FLAG,'-1') TEST_FLAG_WK,NVL(QM.TEST_FLAG,'-1') TEST_FLAG_MAT,
	 CASE WHEN NVL(QM.TEST_FLAG,'-1') = '-1' THEN NVL(P.TEST_FLAG,'-1') ELSE NVL(QM.TEST_FLAG,'-1') END
	 TEST_FLAG,
	 
	 CASE WHEN I.SAP_MOVE_TYPE = '105' THEN
	 INB.REF_SAP_MATDOC_NO 
	 ELSE
	 SUBSTR(I.WMS_SAP_MAT_DOC,0,INSTR(I.WMS_SAP_MAT_DOC,':')-1)
	 END REF_SAP_MATDOC_NO,
	 
	 CASE WHEN I.SAP_MOVE_TYPE = '105' THEN
	 INB.REF_SAP_MATDOC_ITEM_NO 
	 ELSE
	 SUBSTR(I.WMS_SAP_MAT_DOC,INSTR(I.WMS_SAP_MAT_DOC,':')+1,4)
	 END REF_SAP_MATDOC_ITEM_NO,
	 
	 CASE WHEN I.SAP_MOVE_TYPE = '105' THEN
	 INB.REF_SAP_MATDOC_YEAR 
	 ELSE
	 H.PZ_YEAR
	 END REF_SAP_MATDOC_YEAR,
	 
	 nvl(W.BARCODE_FLAG,'0') BARCODE_FLAG,
	(select nvl(IN_QTY,0)+nvl(DESTROY_QTY,0) from WMS_IN_RECEIPT 
	where RECEIPT_NO=I.RECEIPT_NO and RECEIPT_ITEM_NO=I.RECEIPT_ITEM_NO) as RECEIPT_CHECK_QTY,
	(SELECT R.QC_RESULT_CODE FROM WMS_QC_RESULT R WHERE R.INSPECTION_NO=Q.INSPECTION_NO AND R.INSPECTION_ITEM_NO=Q.INSPECTION_ITEM_NO AND rownum = 1 ) QC_RESULT_CODE
	FROM WMS_CORE_WMSDOC_ITEM I 
	LEFT JOIN WMS_CORE_WMSDOC_HEAD H ON I.WMS_NO = H.WMS_NO
	LEFT JOIN WMS_C_WMS_BUSINESS B ON I.BUSINESS_TYPE = B.BUSINESS_TYPE AND I.BUSINESS_NAME=B.BUSINESS_NAME
	AND I.BUSINESS_CLASS = B.BUSINESS_CLASS
	AND I.SOBKZ=B.SOBKZ AND (B.WMS_MOVE_TYPE = I.WMS_MOVE_TYPE or B.WMS_MOVE_TYPE is null)
	LEFT JOIN WMS_IN_INBOUND_ITEM INB ON INB.INBOUND_NO = I.INBOUND_NO AND INB.INBOUND_ITEM_NO = I.INBOUND_ITEM_NO
	LEFT JOIN WMS_QC_INSPECTION_ITEM Q ON Q.RECEIPT_NO=I.RECEIPT_NO AND Q.RECEIPT_ITEM_NO=I.RECEIPT_ITEM_NO
	LEFT JOIN WMS_C_QC_PLANT P ON P.WERKS=I.WERKS AND P.BUSINESS_NAME=I.BUSINESS_NAME AND nvl(P.DEL,'0') !='X'
	AND P.START_DATE &lt;= #{TODAY} AND P.END_DATE >= #{TODAY}
	LEFT JOIN WMS_C_QC_MAT QM ON QM.WERKS = I.WERKS AND QM.MATNR = I.MATNR AND QM.DEL = '0'
	AND QM.START_DATE &lt;= #{TODAY} AND QM.END_DATE >= #{TODAY}
	LEFT JOIN WMS_C_WH W ON W.WERKS=I.WERKS AND W.WH_NUMBER=I.WH_NUMBER AND nvl(W.DEL_FLAG,'0') !='X'
	WHERE I.WMS_NO = #{VO_NO} AND (H.DEL != 'X' OR H.DEL IS NULL)
	AND I.REVERSAL_FLAG = '0' 
	AND I.WERKS=#{WERKS} AND I.WH_NUMBER=#{WH_NUMBER}
	AND I.QTY_WMS > NVL(I.QTY_CANCEL,0) ORDER BY I.WMS_ITEM_NO
	</select>
	<select id="getSapDocHeadInfo" parameterType="Map" resultMap="wmsDocMap">
	SELECT W.*,SH.DOC_DATE AS PZ_DATE,B.BUSINESS_CLASS,B.GM_CODE ,nvl(W.BARCODE_FLAG,'0') BARCODE_FLAG,
	INB.REF_SAP_MATDOC_NO,INB.REF_SAP_MATDOC_ITEM_NO,INB.REF_SAP_MATDOC_YEAR
	FROM WMS_CORE_SAPDOC_ITEM S
	LEFT JOIN WMS_CORE_SAPDOC_HEAD SH ON S.MAT_DOC = SH.MAT_DOC
	LEFT JOIN WMS_CORE_WMSDOC_ITEM W ON S.REF_WMS_ITEM_NO = W.WMS_ITEM_NO AND SH.REF_WMS_NO = W.WMS_NO
	LEFT JOIN WMS_IN_INBOUND_ITEM INB ON INB.INBOUND_NO = W.INBOUND_NO AND INB.INBOUND_ITEM_NO = W.INBOUND_ITEM_NO
	LEFT JOIN WMS_C_WMS_BUSINESS B ON W.BUSINESS_TYPE = B.BUSINESS_TYPE AND W.BUSINESS_NAME=B.BUSINESS_NAME
	AND W.BUSINESS_CLASS = B.BUSINESS_CLASS
  	AND W.SOBKZ=B.SOBKZ AND (B.WMS_MOVE_TYPE=W.WMS_MOVE_TYPE OR B.WMS_MOVE_TYPE IS NULL)
	LEFT JOIN WMS_C_WH WH ON WH.WERKS=W.WERKS AND WH.WH_NUMBER=W.WH_NUMBER AND nvl(WH.DEL_FLAG,'0') !='X'
	WHERE S.MAT_DOC = #{VO_NO} 
	AND W.REVERSAL_FLAG = '0'  AND W.WERKS=#{WERKS} AND W.WH_NUMBER=#{WH_NUMBER}
	AND W.QTY_WMS > NVL(W.QTY_CANCEL,0) ORDER BY W.WMS_ITEM_NO
	</select>
	<update id="updateWmsDocItemQtyCancel" parameterType="Map">
	UPDATE WMS_CORE_WMSDOC_ITEM SET QTY_CANCEL = #{QTY_WMS} WHERE ID = #{ID}
	</update>
	<select id="getReceiptInfoFromReturnItem" parameterType="Map" resultType="Map">
	SELECT RECEIPT_NO,RECEIPT_ITEM_NO FROM WMS_OUT_RETURN_ITEM WHERE 
	RETURN_NO = #{RETURN_NO} AND RETURN_ITEM_NO = #{RETURN_ITEM_NO}
	</select>
	<update id="updateInReceiptQty" parameterType="Map">
	UPDATE WMS_IN_RECEIPT SET RETURNABLE_QTY = (NVL(RETURNABLE_QTY,0) + #{QTY_WMS}) , 
	RETURN_QTY = (NVL(RETURN_QTY,0) - #{QTY_WMS}) 
	WHERE RECEIPT_NO = #{RECEIPT_NO} AND RECEIPT_ITEM_NO = #{RECEIPT_ITEM_NO}
	</update>
	<select id="queryInRhStock" parameterType="Map" resultType="Map">
	SELECT * FROM WMS_IN_RH_STOCK WHERE WERKS = #{WERKS} AND WH_NUMBER = #{WH_NUMBER} AND MATNR = #{MATNR} 
	AND BATCH = #{BATCH} AND SOBKZ = #{SOBKZ} AND LIFNR = #{LIFNR}
	</select>
	<update id="updateInRhStock" parameterType="Map">
	UPDATE WMS_IN_RH_STOCK SET RH_QTY = RH_QTY + #{QTY_WMS} WHERE WERKS = #{WERKS} AND WH_NUMBER = #{WH_NUMBER} 
	AND MATNR = #{MATNR} AND BATCH = #{BATCH} AND SOBKZ = #{SOBKZ} AND LIFNR = #{LIFNR}
	</update>
	<insert id="insertInRhStock" parameterType="Map">
	INSERT INTO WMS_IN_RH_STOCK (ID,WERKS,WH_NUMBER,LGORT,MATNR,MAKTX,BATCH,UNIT,RH_QTY,SOBKZ,
	LIFNR,LIKTX,DEL,CREATOR,CREATE_DATE) VALUES(SEQ_WMS_IN_RH_STOCK.nextval,#{WERKS},#{WH_NUMBER},#{LGORT},#{MATNR},
	#{MAKTX},#{BATCH},#{UNIT},#{QTY_WMS},#{SOBKZ},#{LIFNR},#{LIKTX},'0',#{CREATOR},#{CREATE_DATE})
	</insert>
	<update id="updatePoHx" parameterType="Map">
	UPDATE WMS_HX_PO SET SS124 = (NVL(SS124,0) - #{QTY_WMS} ,HX_QTY = (NVL(HX_QTY) - #{QTY_WMS} WHERE
	WERKS = #{WERKS} AND WH_NUMBER = #{WH_NUMBER} AND MATNR = #{MATNR} AND LIFNR = #{LIFNR}
	</update>
	<update id="updateToHx" parameterType="Map">
	UPDATE WMS_HX_TO SET SS304DB = (NVL(SS304DB,0) - #{QTY_WMS},HX_QTY = (NVL(HX_QTY) - #{QTY_WMS} WHERE
	WERKS = #{WERKS} AND WH_NUMBER = #{WH_NUMBER} AND MATNR = #{MATNR} AND LIFNR = #{LIFNR}
	</update>
	
	<delete id="delSapJobItem" parameterType="Map">
	DELETE FROM WMS_JOB_SAP_ITEM WHERE SAP_JOB_NO = REF_WMS_NO = #{WMS_NO} AND REF_WMS_ITEM_NO = #{REF_WMS_ITEM_NO}
	</delete>
	<delete id="delSapJobHead" parameterType="Map">
	DELETE FROM WMS_JOB_SAP_HEAD H WHERE H.REF_WMS_NO=#{WMS_NO}
	AND (SELECT COUNT(I.ID) FROM WMS_JOB_SAP_ITEM I WHERE I.REF_WMS_NO = H.REF_WMS_NO) = 0
	</delete>
	<update id="updateJobItem" parameterType="Map">
	UPDATE WMS_JOB_SAP_ITEM SET LFIMG = #{LFIMG} WHERE SAP_JOB_NO = REF_WMS_NO = #{WMS_NO} AND REF_WMS_ITEM_NO = #{REF_WMS_ITEM_NO}
	</update>
	<update id="updateCoreStockFreeze" parameterType="Map">
	UPDATE WMS_CORE_STOCK SET FREEZE_QTY = FREEZE_QTY + #{QTY_WMS} WHERE
	WERKS = #{WERKS} AND WH_NUMBER = #{WH_NUMBER} AND MATNR = #{MATNR} AND LIFNR = #{LIFNR} AND SOBKZ = #{SOBKZ}
	</update>
	
	<select id="getCancelBussinessType" parameterType="Map" resultType="Map">
	SELECT DISTINCT BUSINESS_TYPE AS BUSINESS_TYPE FROM WMS_IN_RECEIPT WHERE RECEIPT_NO = 
	(SELECT RECEIPT_NO FROM WMS_OUT_RETURN_ITEM WHERE RETURN_NO = #{RETURN_NO} AND RETURN_ITEM_NO = #{RETURN_ITEM_NO})
	</select>
	<update id="updateInReceiptWhReturnQty" parameterType="Map">
	UPDATE WMS_IN_RECEIPT SET WH_RETURN_QTY = (NVL(WH_RETURN_QTY,0) + #{QTY_WMS} WHERE
	RECEIPT_NO = 
	(SELECT RECEIPT_NO FROM WMS_OUT_RETURN_ITEM WHERE RETURN_NO = #{RETURN_NO} AND RETURN_ITEM_NO = #{RETURN_ITEM_NO})
	AND RECEIPT_ITEM_NO = 
	(SELECT RECEIPT_ITEM_NO FROM WMS_OUT_RETURN_ITEM WHERE RETURN_NO = #{RETURN_NO} AND RETURN_ITEM_NO = #{RETURN_ITEM_NO})
	</update>
	<update id="updateInBoundCancelQty" parameterType="Map">
	UPDATE WMS_IN_INBOUND_ITEM SET QTY_CANCEL = (NVL(QTY_CANCEL,0) + #{QTY_WMS} WHERE
	INBOUND_NO = 
	(SELECT INBOUND_NO FROM WMS_OUT_RETURN_ITEM WHERE RETURN_NO = #{RETURN_NO} AND RETURN_ITEM_NO = #{RETURN_ITEM_NO})
	AND INBOUND_ITEM_NO = 
	(SELECT INBOUND_ITEM_NO FROM WMS_OUT_RETURN_ITEM WHERE RETURN_NO = #{RETURN_NO} AND RETURN_ITEM_NO = #{RETURN_ITEM_NO})
	</update>
	
	<update id="updateInReceipt_Batch" parameterType="list">
		<foreach collection="list" item="d" open="begin" close=" ; end;" separator=";">
			UPDATE WMS_IN_RECEIPT SET RETURN_QTY= cast(NVL(RETURN_QTY,0) as number)+cast(#{d.QTY_WMS} as number) ,
			INABLE_QTY=case when INABLE_QTY>0 then  INABLE_QTY-cast(#{d.QTY_WMS} as number)
				else INABLE_QTY end 
			WHERE RECEIPT_NO=#{d.RECEIPT_NO} AND RECEIPT_ITEM_NO=#{d.RECEIPT_ITEM_NO}
		</foreach>	
	</update>
	
	<update id="updateQCItem_Batch" parameterType="list">
		<foreach collection="list" item="d" open="begin" close=" ; end;" separator=";">
			UPDATE WMS_QC_INSPECTION_ITEM SET INSPECTION_QTY=cast(INSPECTION_QTY as number)-cast(#{d.QTY_WMS} as number) 
			WHERE INSPECTION_NO=#{d.INSPECTION_NO} AND INSPECTION_ITEM_NO=#{d.INSPECTION_ITEM_NO}
		</foreach>	
	</update>
	
	<update id="updateQCResult_Batch" parameterType="list">
		<foreach collection="list" item="d" open="begin" close=" ; end;" separator=";">
			UPDATE WMS_QC_RESULT SET RESULT_QTY=cast(RESULT_QTY as number)-cast(#{d.QTY_WMS} as number) 
			WHERE INSPECTION_NO=#{d.INSPECTION_NO} AND INSPECTION_ITEM_NO=#{d.INSPECTION_ITEM_NO}
		</foreach>
	</update>
	
	<select id="getVoucherReversalDataByLable" parameterType="Map" resultType="Map">
		SELECT L.BOX_QTY,(I.QTY_WMS-nvl(I.QTY_CANCEL,0)) as QTY_WMS_MAX,
		(I.QTY_WMS-nvl(I.QTY_CANCEL,0)) as QTY_WMS,I.*,
		H.PZ_DATE,B.BUSINESS_CLASS,B.GM_CODE,Q.INSPECTION_ITEM_STATUS,P.TEST_FLAG,	
		nvl(BARCODE_FLAG,'0') BARCODE_FLAG,
		(select nvl(IN_QTY,0)+nvl(DESTROY_QTY,0) from WMS_IN_RECEIPT 
			where RECEIPT_NO=I.RECEIPT_NO and RECEIPT_ITEM_NO=I.RECEIPT_ITEM_NO) as RECEIPT_CHECK_QTY,
		(SELECT R.QC_RESULT_CODE FROM WMS_QC_RESULT R 
		WHERE R.INSPECTION_NO=Q.INSPECTION_NO AND R.INSPECTION_ITEM_NO=Q.INSPECTION_ITEM_NO AND rownum = 1 ) QC_RESULT_CODE
		FROM WMS_CORE_WMSDOC_ITEM I
		LEFT JOIN WMS_CORE_LABEL L on instr(','||I.LABEL_NO||',',L.LABEL_NO)>0
		and I.WERKS=L.WERKS and I.WH_NUMBER=L.WH_NUMBER
		LEFT JOIN WMS_CORE_WMSDOC_HEAD H ON I.WMS_NO = H.WMS_NO
		LEFT JOIN WMS_C_WMS_BUSINESS B ON I.BUSINESS_TYPE = B.BUSINESS_TYPE AND I.BUSINESS_NAME=B.BUSINESS_NAME
			AND I.SOBKZ=B.SOBKZ AND B.WMS_MOVE_TYPE=I.WMS_MOVE_TYPE
		LEFT JOIN WMS_QC_INSPECTION_ITEM Q ON Q.RECEIPT_NO=I.RECEIPT_NO AND Q.RECEIPT_ITEM_NO=I.RECEIPT_ITEM_NO
		LEFT JOIN WMS_C_QC_PLANT P ON P.WERKS=I.WERKS AND P.BUSINESS_NAME=I.BUSINESS_NAME AND nvl(P.DEL,'0') !='X'
		LEFT JOIN WMS_C_WH W ON W.WERKS=I.WERKS AND W.WH_NUMBER=I.WH_NUMBER AND nvl(W.DEL_FLAG,'0') !='X'
		where L.LABEL_NO = #{LABEL_NO} and nvl(L.DEL,'0')!='X' 
		<if test="ACTION_TYPE == '01' ">
			and L.LABEL_STATUS in ('01','02','03','04') and I.BUSINESS_CLASS='01'
		</if>
		<if test="ACTION_TYPE == '02' ">
			and L.LABEL_STATUS ='08' and I.BUSINESS_CLASS in ('02','03')
		</if>
		 and I.REVERSAL_FLAG ='0'
		and nvl(I.DEL,'0')!='X' and I.WERKS = #{WERKS} and I.WH_NUMBER = #{WH_NUMBER}
		and instr(','||I.LABEL_NO||',',#{LABEL_NO})>0
		and I.QTY_WMS > NVL(I.QTY_CANCEL,0)
		and ROWNUM=1
		order by I.CREATE_DATE desc 
	</select>
	
	<select id="getReversalJobInfo" parameterType="Map" resultType="Map">
	SELECT I.ID IID,J.ID JID,NVL(I.WMS_SAP_MAT_DOC, '0') WMS_SAP_MAT_DOC,J.LFIMG,J.POST_QTY FROM WMS_CORE_WMSDOC_ITEM I 
	LEFT JOIN WMS_JOB_SAP_ITEM J ON I.WMS_NO = J.REF_WMS_NO AND I.WMS_ITEM_NO = J.REF_WMS_ITEM_NO
	WHERE I.WMS_NO=#{WMS_NO} AND I.WMS_ITEM_NO = #{WMS_ITEM_NO}
	</select>
	
</mapper>